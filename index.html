import React, { useState, useEffect } from 'react';
import { BookOpen, CheckCircle, FileText, Brain, AlertCircle, LogOut, Target, Lightbulb, TrendingUp } from 'lucide-react';

const AIClassroomAgent = () => {
  const [activeTab, setActiveTab] = useState('connect');
  const [isConnected, setIsConnected] = useState(false);
  const [user, setUser] = useState(null);
  const [accessToken, setAccessToken] = useState(null);
  const [courses, setCourses] = useState([]);
  const [selectedCourse, setSelectedCourse] = useState(null);
  const [courseData, setCourseData] = useState(null);
  const [gradeLevel, setGradeLevel] = useState('');
  const [subject, setSubject] = useState('');
  const [analysis, setAnalysis] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [error, setError] = useState(null);
  const [grade7MathStandards, setGrade7MathStandards] = useState(null);
  const [loadingStandards, setLoadingStandards] = useState(false);

  // Load Grade 7 Math Standards from GitHub
  useEffect(() => {
    const loadGrade7Standards = async () => {
      setLoadingStandards(true);
      try {
        const response = await fetch('https://raw.githubusercontent.com/parthj854/clarified/main/standards-grade7-math.pdf');
        const blob = await response.blob();
        
        // For now, we'll use a comprehensive hardcoded version based on the PDF
        // In production, you'd parse the PDF with a library like pdf.js
        const standards = {
          '7.RP': {
            title: 'Ratios and Proportional Relationships',
            standards: [
              '7.RP.1: Compute unit rates associated with ratios of fractions',
              '7.RP.2.a: Decide whether two quantities are in a proportional relationship',
              '7.RP.2.b: Identify the constant of proportionality (unit rate)',
              '7.RP.2.c: Represent proportional relationships by equations',
              '7.RP.2.d: Explain what a point (x, y) on the graph means in context',
              '7.RP.3: Use proportional relationships to solve multistep ratio and percent problems'
            ]
          },
          '7.NS': {
            title: 'The Number System',
            standards: [
              '7.NS.1.a: Describe situations in which opposite quantities combine to make 0',
              '7.NS.1.b: Understand p + q as the number located a distance |q| from p',
              '7.NS.1.c: Understand subtraction of rational numbers as adding the additive inverse',
              '7.NS.1.d: Apply properties of operations to add and subtract rational numbers',
              '7.NS.2.a: Understand multiplication extended from fractions to rational numbers',
              '7.NS.2.b: Understand integers can be divided, quotient is a rational number',
              '7.NS.2.c: Apply properties of operations to multiply and divide rational numbers',
              '7.NS.2.d: Convert a rational number to a decimal using long division',
              '7.NS.3: Solve real-world problems involving four operations with rational numbers'
            ]
          },
          '7.EE': {
            title: 'Expressions and Equations',
            standards: [
              '7.EE.1: Apply properties to add, subtract, factor, and expand linear expressions',
              '7.EE.2: Understand rewriting expressions in different forms sheds light on the problem',
              '7.EE.3: Solve multi-step real-life problems with positive and negative rational numbers',
              '7.EE.4.a: Solve word problems leading to equations of the form px + q = r',
              '7.EE.4.b: Solve word problems leading to inequalities of the form px + q > r'
            ]
          },
          '7.G': {
            title: 'Geometry',
            standards: [
              '7.G.1: Solve problems involving scale drawings of geometric figures',
              '7.G.2: Draw geometric shapes with given conditions',
              '7.G.3: Describe 2D figures from slicing 3D figures',
              '7.G.4: Know formulas for area and circumference of a circle',
              '7.G.5: Use facts about angles to write and solve equations for unknown angles',
              '7.G.6: Solve problems involving area, volume and surface area of 2D and 3D objects'
            ]
          },
          '7.SP': {
            title: 'Statistics and Probability',
            standards: [
              '7.SP.1: Understand statistics can gain information about a population from a sample',
              '7.SP.2: Use data from random sample to draw inferences about a population',
              '7.SP.3: Assess degree of visual overlap of two numerical data distributions',
              '7.SP.4: Use measures of center and variability to draw comparative inferences',
              '7.SP.5: Understand probability is a number between 0 and 1',
              '7.SP.6: Approximate probability by collecting data on the chance process',
              '7.SP.7.a: Develop a uniform probability model',
              '7.SP.7.b: Develop a probability model by observing frequencies in data',
              '7.SP.8.a: Probability of compound event is fraction of outcomes',
              '7.SP.8.b: Represent sample spaces for compound events',
              '7.SP.8.c: Design and use simulation to generate frequencies for compound events'
            ]
          }
        };
        
        setGrade7MathStandards(standards);
      } catch (error) {
        console.error('Error loading standards:', error);
      } finally {
        setLoadingStandards(false);
      }
    };

    loadGrade7Standards();
  }, []);

  // California Common Core Standards Database (sample - expandable)
  const californiaStandards = {
    'Math': {
      'K': [
        'K.CC.A.1: Count to 100 by ones and by tens',
        'K.CC.B.4: Understand the relationship between numbers and quantities',
        'K.OA.A.1: Represent addition and subtraction with objects'
      ],
      '1': [
        '1.OA.A.1: Use addition and subtraction within 20 to solve word problems',
        '1.NBT.B.2: Understand that the two digits of a two-digit number represent amounts of tens and ones',
        '1.MD.A.1: Order three objects by length'
      ],
      '3': [
        '3.OA.A.1: Interpret products of whole numbers',
        '3.NF.A.1: Understand a fraction 1/b as the quantity formed by 1 part when a whole is partitioned into b equal parts',
        '3.MD.C.7: Relate area to operations of multiplication and addition'
      ],
      '5': [
        '5.NF.B.4: Apply and extend previous understandings of multiplication to multiply a fraction or whole number by a fraction',
        '5.NBT.B.7: Add, subtract, multiply, and divide decimals to hundredths',
        '5.G.B.3: Understand that attributes belonging to a category of two-dimensional figures'
      ],
      '8': [
        '8.EE.A.1: Know and apply the properties of integer exponents to generate equivalent numerical expressions',
        '8.F.A.1: Understand that a function is a rule that assigns to each input exactly one output',
        '8.G.B.7: Apply the Pythagorean Theorem to determine unknown side lengths'
      ],
      '9-12': [
        'A-SSE.A.1: Interpret expressions that represent a quantity in terms of its context',
        'F-IF.C.7: Graph functions expressed symbolically and show key features of the graph',
        'G-CO.A.1: Know precise definitions of angle, circle, perpendicular line, parallel line'
      ]
    },
    'ELA': {
      'K': [
        'RL.K.1: With prompting and support, ask and answer questions about key details in a text',
        'RF.K.1: Demonstrate understanding of the organization and basic features of print',
        'W.K.1: Use a combination of drawing, dictating, and writing to compose opinion pieces'
      ],
      '3': [
        'RL.3.1: Ask and answer questions to demonstrate understanding of a text',
        'RI.3.8: Describe the logical connection between particular sentences and paragraphs',
        'W.3.2: Write informative/explanatory texts to examine a topic'
      ],
      '5': [
        'RL.5.2: Determine a theme of a story, drama, or poem from details in the text',
        'RI.5.6: Analyze multiple accounts of the same event or topic',
        'W.5.3: Write narratives to develop real or imagined experiences'
      ],
      '8': [
        'RL.8.3: Analyze how particular lines of dialogue or incidents in a story propel the action',
        'RI.8.8: Delineate and evaluate the argument and specific claims in a text',
        'W.8.1: Write arguments to support claims with clear reasons and relevant evidence'
      ],
      '9-12': [
        'RL.11-12.2: Determine two or more themes or central ideas of a text',
        'RI.11-12.6: Determine an author\'s point of view or purpose',
        'W.11-12.2: Write informative/explanatory texts to examine and convey complex ideas'
      ]
    },
    'Science': {
      'K': [
        'K-PS2-1: Plan and conduct an investigation to compare the effects of different strengths or directions of pushes and pulls',
        'K-LS1-1: Use observations to describe patterns of what plants and animals need to survive',
        'K-ESS2-1: Use and share observations of local weather conditions'
      ],
      '5': [
        '5-PS1-1: Develop a model to describe that matter is made of particles too small to be seen',
        '5-LS2-1: Develop a model to describe the movement of matter among plants, animals',
        '5-ESS1-1: Support an argument that differences in the apparent brightness of the sun'
      ],
      '8': [
        'MS-PS1-1: Develop models to describe the atomic composition of simple molecules',
        'MS-LS1-6: Construct a scientific explanation based on evidence for the role of photosynthesis',
        'MS-ESS1-2: Develop and use a model to describe the role of gravity'
      ],
      '9-12': [
        'HS-PS1-1: Use the periodic table as a model to predict properties of elements',
        'HS-LS1-2: Develop and use a model to illustrate the hierarchical organization of interacting systems',
        'HS-ESS1-1: Develop a model based on evidence to illustrate the life span of the sun'
      ]
    }
  };

  const handleGoogleSignIn = () => {
    if (!window.google) {
      setError('Google Sign-In is loading. Please wait and try again.');
      return;
    }

    try {
      const client = window.google.accounts.oauth2.initTokenClient({
        client_id: '678343598174-cl1orhj1onnq5r79esv7sf0i6mht3p26.apps.googleusercontent.com',
        scope: [
          'https://www.googleapis.com/auth/classroom.courses.readonly',
          'https://www.googleapis.com/auth/classroom.coursework.students',
          'https://www.googleapis.com/auth/userinfo.profile',
          'https://www.googleapis.com/auth/userinfo.email'
        ].join(' '),
        callback: async (tokenResponse) => {
          if (tokenResponse.access_token) {
            setAccessToken(tokenResponse.access_token);
            await fetchUserInfo(tokenResponse.access_token);
            await fetchCourses(tokenResponse.access_token);
            setIsConnected(true);
            setActiveTab('courses');
          }
        },
      });
      client.requestAccessToken();
    } catch (err) {
      setError('Sign-in failed. Please try again or use Demo Mode.');
    }
  };

  const fetchUserInfo = async (token) => {
    try {
      const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const userData = await response.json();
      setUser(userData);
    } catch (error) {
      console.error('Error fetching user info:', error);
    }
  };

  const simulateConnection = () => {
    setUser({ name: 'Demo Teacher', email: 'demo@school.edu', picture: null });
    setAccessToken('demo_token');
    setIsConnected(true);
    setCourses([
      { id: '123456', name: 'Grade 3 Mathematics', section: 'Room 204' },
      { id: '789012', name: 'Grade 5 English Language Arts', section: 'Room 301' },
      { id: '345678', name: 'Grade 8 Science', section: 'Lab 102' }
    ]);
    setActiveTab('courses');
  };

  const fetchCourses = async (token) => {
    try {
      const response = await fetch(
        'https://classroom.googleapis.com/v1/courses?courseStates=ACTIVE&pageSize=20',
        { headers: { 'Authorization': `Bearer ${token}` }}
      );
      if (response.ok) {
        const data = await response.json();
        setCourses(data.courses || []);
      } else {
        simulateConnection();
      }
    } catch (err) {
      simulateConnection();
    }
  };

  const fetchCourseDetails = async (courseId) => {
    setSelectedCourse(courseId);
    
    // Fetch real course work if connected
    if (accessToken !== 'demo_token') {
      try {
        const response = await fetch(
          `https://classroom.googleapis.com/v1/courses/${courseId}/courseWork?pageSize=50`,
          { headers: { 'Authorization': `Bearer ${accessToken}` }}
        );
        
        if (response.ok) {
          const data = await response.json();
          // Process real data
        }
      } catch (err) {
        console.error('Error fetching course work:', err);
      }
    }
    
    // Demo data
    setCourseData({
      courseName: courses.find(c => c.id === courseId)?.name || "Grade 3 Mathematics",
      assignments: [
        { 
          id: 1, 
          title: "Multiplication Worksheet", 
          description: "Complete problems 1-20 on page 45. Show your work for each problem.",
          dueDate: "2024-12-25",
          maxPoints: 20,
          type: "Assignment"
        },
        { 
          id: 2, 
          title: "Fractions Quiz", 
          description: "Quiz on adding and subtracting fractions with like denominators",
          dueDate: "2024-12-28",
          maxPoints: 100,
          type: "Quiz"
        },
        {
          id: 3,
          title: "Word Problems Homework",
          description: "Solve 5 multi-step word problems involving addition and subtraction",
          dueDate: "2025-01-03",
          maxPoints: 25,
          type: "Assignment"
        }
      ],
      materials: [
        {
          id: 1,
          title: "Course Syllabus",
          description: "Grade 3 Mathematics - Common Core aligned curriculum"
        },
        {
          id: 2,
          title: "Multiplication Tables",
          description: "Reference sheet for times tables 1-12"
        }
      ],
      syllabus: "Grade 3 Mathematics: This course covers multiplication and division, fractions, geometry, and measurement aligned with California Common Core Standards."
    });
    
    setActiveTab('setup');
  };

  const analyzeWithClaude = async () => {
    if (!gradeLevel || !subject) {
      setError('Please select both grade level and subject before analyzing.');
      return;
    }

    setIsAnalyzing(true);
    setError(null);

    try {
      // Use Grade 7 Math standards from GitHub if available
      let relevantStandards = [];
      let standardsDetail = '';
      
      if (gradeLevel === '7' && subject === 'Math' && grade7MathStandards) {
        // Build comprehensive standards list from the loaded data
        Object.keys(grade7MathStandards).forEach(domain => {
          const domainData = grade7MathStandards[domain];
          standardsDetail += `\n${domain} - ${domainData.title}:\n`;
          domainData.standards.forEach(std => {
            relevantStandards.push(std);
            standardsDetail += `  - ${std}\n`;
          });
        });
      } else {
        relevantStandards = californiaStandards[subject]?.[gradeLevel] || [];
        standardsDetail = relevantStandards.join('\n');
      }

      // Extract detailed assignment information including materials
      const detailedAssignments = courseData.assignments.map(a => {
        let assignmentDetail = `
ASSIGNMENT: ${a.title}
Type: ${a.type}
Description: ${a.description}
Points: ${a.maxPoints}
Due Date: ${a.dueDate}`;

        // Add materials/attachments info
        if (a.materials && a.materials.length > 0) {
          assignmentDetail += `\nAttachments:`;
          a.materials.forEach(material => {
            if (material.driveFile) {
              assignmentDetail += `\n  - ${material.driveFile.driveFile.title} (Google Drive file)`;
            } else if (material.youtubeVideo) {
              assignmentDetail += `\n  - Video: ${material.youtubeVideo.title}`;
            } else if (material.link) {
              assignmentDetail += `\n  - Link: ${material.link.title || material.link.url}`;
            } else if (material.form) {
              assignmentDetail += `\n  - Google Form: ${material.form.title}`;
            }
          });
        }

        return assignmentDetail;
      }).join('\n\n---\n');

      // Extract materials information
      const detailedMaterials = courseData.materials.map(m => {
        let materialDetail = `MATERIAL: ${m.title}\nDescription: ${m.description}`;
        
        if (m.materials && m.materials.length > 0) {
          materialDetail += `\nAttachments:`;
          m.materials.forEach(material => {
            if (material.driveFile) {
              materialDetail += `\n  - ${material.driveFile.driveFile.title}`;
            } else if (material.link) {
              materialDetail += `\n  - ${material.link.title || material.link.url}`;
            }
          });
        }
        
        return materialDetail;
      }).join('\n\n');
      
      const prompt = `You are an educational standards expert specializing in California Common Core Standards for Grade 7 Mathematics.

Analyze this REAL course content from Google Classroom for a Grade ${gradeLevel} ${subject} class:

COURSE NAME: ${courseData.courseName}

COURSE SYLLABUS/DESCRIPTION:
${courseData.syllabus}

DETAILED ASSIGNMENTS (${courseData.assignments.length} total):
${detailedAssignments}

COURSE MATERIALS (${courseData.materials.length} total):
${detailedMaterials}

CALIFORNIA COMMON CORE STANDARDS FOR GRADE 7 MATHEMATICS:
${standardsDetail}

These standards cover five major domains:
1. Ratios and Proportional Relationships (7.RP) - 6 standards
2. The Number System (7.NS) - 9 standards
3. Expressions and Equations (7.EE) - 5 standards
4. Geometry (7.G) - 6 standards
5. Statistics and Probability (7.SP) - 11 standards

IMPORTANT: Analyze the ACTUAL assignments and materials provided. Look at:
- The specific topics covered in each assignment
- The depth and complexity of questions/tasks
- The types of assessments (worksheets, quizzes, projects, etc.)
- What materials are attached (videos, documents, forms, links)
- The progression and sequence of content
- Real-world applications and problem-solving opportunities

Provide a comprehensive, expert-level analysis in JSON format. Be extremely specific about which standards are addressed and which are missing. Reference the exact standard codes (e.g., 7.RP.1, 7.NS.2.a).

{
  "overallAlignment": {
    "score": <number 0-100>,
    "summary": "<2-3 sentence expert analysis of overall alignment quality based on ACTUAL content>",
    "domainCoverage": {
      "7.RP": <percentage 0-100>,
      "7.NS": <percentage 0-100>,
      "7.EE": <percentage 0-100>,
      "7.G": <percentage 0-100>,
      "7.SP": <percentage 0-100>
    }
  },
  "standardsAnalysis": {
    "fullyAligned": [
      {
        "standard": "<exact standard code and description>",
        "evidence": "<which SPECIFIC assignment/material with concrete examples from the content>",
        "quality": "<depth and quality of coverage - be critical and specific>"
      }
    ],
    "partiallyAligned": [
      {
        "standard": "<exact standard code>",
        "currentCoverage": "<what aspects are currently addressed in which assignments>",
        "missing": "<what specific elements are missing to fully meet the standard>"
      }
    ],
    "notAddressed": [
      {
        "standard": "<exact standard code>",
        "importance": "<why this specific standard is critical for Grade 7>",
        "impact": "<concrete impact on student learning and next grade readiness>"
      }
    ]
  },
  "assignmentAnalysis": [
    {
      "assignment": "<exact assignment title>",
      "strengths": ["<specific strength with standard reference and concrete example>"],
      "weaknesses": ["<specific weakness with standard reference>"],
      "alignmentScore": <0-100>,
      "standardsAddressed": ["<list specific standard codes>"],
      "recommendedChanges": ["<concrete, actionable changes with standard justification>"]
    }
  ],
  "recommendations": {
    "immediate": [
      {
        "action": "<specific, implementable action>",
        "standard": "<exact standard code it addresses>",
        "implementation": "<detailed step-by-step implementation guide>",
        "timeframe": "<realistic timeframe>",
        "resources": "<what materials/resources needed>"
      }
    ],
    "shortTerm": ["<1-2 week improvements with standard codes>"],
    "longTerm": ["<semester improvements with standard codes>"]
  },
  "gapAnalysis": {
    "criticalGaps": ["<missing standards with codes that are essential>"],
    "sequencingIssues": ["<problems with progression citing standards>"],
    "depthConcerns": ["<standards that lack depth with codes>"],
    "missingDomains": ["<entire domains underrepresented>"]
  },
  "alternativeActivities": [
    {
      "replaces": "<assignment to replace or supplement>",
      "activity": "<detailed new activity description>",
      "standards": ["<exact standard codes it addresses>"],
      "rationale": "<why this better addresses the standards>",
      "implementation": "<step-by-step implementation guide with materials needed>",
      "assessmentStrategy": "<how to assess student mastery>",
      "differentiationOptions": "<how to adapt for different learners>"
    }
  ]
}

Be rigorous, specific, and actionable. Use exact standard codes throughout. Provide concrete examples from the actual assignments and materials.`;

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4000,
          messages: [
            {
              role: 'user',
              content: prompt
            }
          ]
        })
      });

      const data = await response.json();
      const responseText = data.content
        .filter(block => block.type === 'text')
        .map(block => block.text)
        .join('\n');
      
      // Clean and parse JSON
      const cleanedText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      const analysisResult = JSON.parse(cleanedText);
      
      setAnalysis(analysisResult);
      setActiveTab('results');
    } catch (err) {
      console.error('Analysis error:', err);
      setError('Analysis failed. Using demo data for now.');
      
      // Fallback demo data
      setAnalysis({
        overallAlignment: {
          score: 72,
          summary: "The course demonstrates moderate alignment with California Common Core Standards. Strong foundation in basic operations, but lacks depth in conceptual understanding and problem-solving strategies."
        },
        standardsAnalysis: {
          fullyAligned: [
            {
              standard: "3.OA.A.1: Interpret products of whole numbers",
              evidence: "Multiplication Worksheet assignment directly addresses this standard",
              quality: "Good coverage with multiple practice opportunities"
            }
          ],
          partiallyAligned: [
            {
              standard: "3.NF.A.1: Understand fractions as quantities",
              currentCoverage: "Fractions quiz covers operations but lacks conceptual understanding",
              missing: "Need activities exploring fractions as parts of a whole, visual models, real-world applications"
            }
          ],
          notAddressed: [
            {
              standard: "3.MD.C.7: Relate area to multiplication and addition",
              importance: "Critical for connecting geometry concepts to operations",
              impact: "Students may struggle with multi-dimensional thinking and spatial reasoning"
            }
          ]
        },
        assignmentAnalysis: [
          {
            assignment: "Multiplication Worksheet",
            strengths: ["Provides adequate practice", "Clear instructions"],
            weaknesses: ["Only procedural practice", "No real-world context", "Missing visual representations"],
            alignmentScore: 65,
            recommendedChanges: [
              "Add word problems involving real-world scenarios (e.g., organizing items in arrays)",
              "Include problems requiring students to draw arrays or area models",
              "Add reflection questions about multiplication strategies"
            ]
          },
          {
            assignment: "Fractions Quiz",
            strengths: ["Covers essential fraction operations"],
            weaknesses: ["Heavy emphasis on procedures over concepts", "No visual models", "Limited to like denominators"],
            alignmentScore: 58,
            recommendedChanges: [
              "Add questions requiring students to draw fraction models",
              "Include comparison problems with visual representations",
              "Add real-world application problems (e.g., sharing pizza, measuring ingredients)"
            ]
          }
        ],
        recommendations: {
          immediate: [
            {
              action: "Revise Fractions Quiz to include visual models",
              standard: "3.NF.A.1",
              implementation: "Add 3-4 questions where students must draw fraction bars or circles to represent fractions",
              timeframe: "Before next quiz administration"
            },
            {
              action: "Add area/multiplication connection activity",
              standard: "3.MD.C.7",
              implementation: "Create activity where students design rectangular gardens and calculate area using multiplication",
              timeframe: "Within 2 weeks"
            }
          ],
          shortTerm: [
            "Integrate more visual/manipulative-based fraction activities",
            "Add measurement activities connecting geometry and operations",
            "Include more multi-step word problems requiring strategic thinking"
          ],
          longTerm: [
            "Develop project-based learning unit integrating multiple standards",
            "Create differentiated learning stations for various skill levels",
            "Build in more formative assessment opportunities throughout units"
          ]
        },
        gapAnalysis: {
          criticalGaps: [
            "Geometry and measurement standards under-represented",
            "Limited opportunities for mathematical reasoning and justification",
            "Insufficient real-world problem-solving contexts"
          ],
          sequencingIssues: [
            "Fractions introduced without adequate conceptual foundation",
            "Area concepts should precede advanced multiplication"
          ],
          depthConcerns: [
            "Assignments focus on procedures rather than deep understanding",
            "Limited opportunities for students to explain their thinking",
            "Insufficient connection between different mathematical concepts"
          ]
        },
        alternativeActivities: [
          {
            replaces: "Multiplication Worksheet",
            activity: "Array City Design Project",
            standards: ["3.OA.A.1", "3.OA.A.3", "3.MD.C.7"],
            rationale: "Connects multiplication to area and real-world design, promotes deeper understanding through application",
            implementation: "1) Students design a city block using grid paper\n2) Each building must be a rectangle with dimensions they choose\n3) Calculate area of each building using multiplication\n4) Find total area of city block\n5) Write word problems about their city for classmates to solve\n6) Present and explain their design choices"
          },
          {
            replaces: "Fractions Quiz - Supplement",
            activity: "Fraction Recipe Challenge",
            standards: ["3.NF.A.1", "3.NF.A.3"],
            rationale: "Provides real-world context for fraction operations, requires visual representation and conceptual understanding",
            implementation: "1) Provide recipe for 4 people\n2) Students must adjust recipe for different group sizes (2, 6, 8 people)\n3) Draw fraction models showing ingredient amounts\n4) Explain their reasoning with visual models\n5) Compare fractions to determine which adjusted recipe uses more of specific ingredients"
          },
          {
            replaces: "Word Problems Homework",
            activity: "Math Story Writing Workshop",
            standards: ["3.OA.D.8", "3.MD.A.2"],
            rationale: "Deepens understanding by having students create problems, not just solve them; promotes mathematical communication",
            implementation: "1) Students write 3 original word problems using specified operations\n2) Must include real-world context relevant to their lives\n3) Create answer keys with multiple solution strategies\n4) Exchange problems with partner for peer solving\n5) Discuss different solution approaches as class"
          }
        ]
      });
      setActiveTab('results');
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleSignOut = () => {
    setIsConnected(false);
    setUser(null);
    setAccessToken(null);
    setCourses([]);
    setSelectedCourse(null);
    setCourseData(null);
    setAnalysis(null);
    setGradeLevel('');
    setSubject('');
    setActiveTab('connect');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Brain className="w-8 h-8 text-indigo-600" />
              <div>
                <h1 className="text-3xl font-bold text-gray-800">California Common Core Analyzer</h1>
                <p className="text-sm text-gray-600">AI-Powered Standards Alignment Analysis</p>
              </div>
            </div>
            <div className="flex items-center gap-4">
              {isConnected && user && (
                <div className="flex items-center gap-3">
                  {user.picture && <img src={user.picture} alt={user.name} className="w-8 h-8 rounded-full" />}
                  <div>
                    <div className="text-sm font-medium">{user.name}</div>
                    <div className="text-xs text-gray-500">{user.email}</div>
                  </div>
                  <button onClick={handleSignOut} className="p-2 hover:bg-gray-100 rounded-lg">
                    <LogOut className="w-5 h-5 text-gray-600" />
                  </button>
                </div>
              )}
              <div className="flex items-center gap-2">
                {isConnected ? (
                  <>
                    <CheckCircle className="w-5 h-5 text-green-500" />
                    <span className="text-sm text-green-600 font-medium">Connected</span>
                  </>
                ) : (
                  <>
                    <AlertCircle className="w-5 h-5 text-gray-400" />
                    <span className="text-sm text-gray-500">Not connected</span>
                  </>
                )}
              </div>
            </div>
          </div>
        </div>

        {error && (
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <p className="text-yellow-800 text-sm">{error}</p>
          </div>
        )}

        {/* Navigation */}
        <div className="bg-white rounded-lg shadow-lg mb-6">
          <div className="flex border-b overflow-x-auto">
            {['connect', 'courses', 'setup', 'results'].map((tab) => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                disabled={!isConnected && tab !== 'connect'}
                className={`flex-1 py-4 px-6 text-center font-medium capitalize ${activeTab === tab ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500'} ${!isConnected && tab !== 'connect' ? 'opacity-50 cursor-not-allowed' : ''}`}
              >
                {tab === 'setup' ? 'Configure Analysis' : tab}
              </button>
            ))}
          </div>
        </div>

        {/* Content */}
        <div className="bg-white rounded-lg shadow-lg p-6">
          {/* Connect Tab */}
          {activeTab === 'connect' && (
            <div className="text-center py-12">
              <BookOpen className="w-16 h-16 text-indigo-600 mx-auto mb-4" />
              <h2 className="text-2xl font-bold mb-4">Connect Your Google Classroom</h2>
              <p className="text-gray-600 mb-8 max-w-md mx-auto">
                Sign in to analyze your courses against California Common Core Standards
              </p>
              <button onClick={handleGoogleSignIn} className="bg-white border-2 border-gray-300 px-8 py-3 rounded-lg font-medium hover:bg-gray-50 flex items-center gap-3 mx-auto mb-4">
                <svg className="w-5 h-5" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
              </button>
              <button onClick={simulateConnection} className="text-sm text-gray-500 underline">
                Try Demo Mode
              </button>
            </div>
          )}

          {/* Courses Tab */}
          {activeTab === 'courses' && (
            <div>
              <h2 className="text-2xl font-bold mb-6">Select a Course to Analyze</h2>
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                {courses.map(course => (
                  <button
                    key={course.id}
                    onClick={() => fetchCourseDetails(course.id)}
                    className="text-left p-6 border-2 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 transition-all"
                  >
                    <h3 className="font-semibold text-lg mb-2">{course.name}</h3>
                    <p className="text-sm text-gray-600">{course.section}</p>
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Setup Tab */}
          {activeTab === 'setup' && courseData && (
            <div>
              <h2 className="text-2xl font-bold mb-6">Configure Standards Analysis</h2>
              
              <div className="bg-gray-50 rounded-lg p-6 mb-6">
                <h3 className="font-semibold text-lg mb-4">{courseData.courseName}</h3>
                
                {/* Grade and Subject Selection */}
                <div className="grid md:grid-cols-2 gap-6 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Grade Level</label>
                    <select
                      value={gradeLevel}
                      onChange={(e) => setGradeLevel(e.target.value)}
                      className="w-full border rounded-lg px-4 py-2"
                    >
                      <option value="">Select Grade Level</option>
                      <option value="K">Kindergarten</option>
                      <option value="1">Grade 1</option>
                      <option value="2">Grade 2</option>
                      <option value="3">Grade 3</option>
                      <option value="4">Grade 4</option>
                      <option value="5">Grade 5</option>
                      <option value="6">Grade 6</option>
                      <option value="7">Grade 7</option>
                      <option value="8">Grade 8</option>
                      <option value="9-12">High School (9-12)</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Subject Area</label>
                    <select
                      value={subject}
                      onChange={(e) => setSubject(e.target.value)}
                      className="w-full border rounded-lg px-4 py-2"
                    >
                      <option value="">Select Subject</option>
                      <option value="Math">Mathematics</option>
                      <option value="ELA">English Language Arts</option>
                      <option value="Science">Science (NGSS)</option>
                    </select>
                  </div>
                </div>

                {gradeLevel && subject && californiaStandards[subject]?.[gradeLevel] && (
                  <div className="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 className="font-medium text
