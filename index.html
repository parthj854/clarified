import React, { useState, useEffect } from 'react';
import { BookOpen, CheckCircle, FileText, Brain, AlertCircle, LogOut, Target, Lightbulb, TrendingUp } from 'lucide-react';

const AIClassroomAgent = () => {
  const [activeTab, setActiveTab] = useState('connect');
  const [isConnected, setIsConnected] = useState(false);
  const [user, setUser] = useState(null);
  const [accessToken, setAccessToken] = useState(null);
  const [courses, setCourses] = useState([]);
  const [selectedCourse, setSelectedCourse] = useState(null);
  const [courseData, setCourseData] = useState(null);
  const [gradeLevel, setGradeLevel] = useState('');
  const [subject, setSubject] = useState('');
  const [analysis, setAnalysis] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [error, setError] = useState(null);
  const [grade7MathStandards, setGrade7MathStandards] = useState(null);
  const [loadingStandards, setLoadingStandards] = useState(false);

  useEffect(() => {
    const loadGrade7Standards = async () => {
      setLoadingStandards(true);
      const standards = {
        '7.RP': {
          title: 'Ratios and Proportional Relationships',
          standards: [
            '7.RP.1: Compute unit rates associated with ratios of fractions',
            '7.RP.2.a: Decide whether two quantities are in a proportional relationship',
            '7.RP.2.b: Identify the constant of proportionality (unit rate)',
            '7.RP.2.c: Represent proportional relationships by equations',
            '7.RP.2.d: Explain what a point (x, y) on the graph means in context',
            '7.RP.3: Use proportional relationships to solve multistep ratio and percent problems'
          ]
        },
        '7.NS': {
          title: 'The Number System',
          standards: [
            '7.NS.1.a: Describe situations in which opposite quantities combine to make 0',
            '7.NS.1.b: Understand p + q as the number located a distance from p',
            '7.NS.1.c: Understand subtraction of rational numbers',
            '7.NS.1.d: Apply properties of operations to add and subtract rational numbers',
            '7.NS.2.a: Understand multiplication extended to rational numbers',
            '7.NS.2.b: Understand integers can be divided',
            '7.NS.2.c: Apply properties to multiply and divide rational numbers',
            '7.NS.2.d: Convert rational number to decimal using long division',
            '7.NS.3: Solve real-world problems with four operations on rational numbers'
          ]
        },
        '7.EE': {
          title: 'Expressions and Equations',
          standards: [
            '7.EE.1: Apply properties to add, subtract, factor, and expand linear expressions',
            '7.EE.2: Rewriting expressions sheds light on the problem',
            '7.EE.3: Solve multi-step problems with rational numbers',
            '7.EE.4.a: Solve word problems leading to equations px + q = r',
            '7.EE.4.b: Solve word problems leading to inequalities'
          ]
        },
        '7.G': {
          title: 'Geometry',
          standards: [
            '7.G.1: Solve problems involving scale drawings',
            '7.G.2: Draw geometric shapes with given conditions',
            '7.G.3: Describe 2D figures from slicing 3D figures',
            '7.G.4: Know formulas for area and circumference of a circle',
            '7.G.5: Use facts about angles to solve equations',
            '7.G.6: Solve problems involving area, volume and surface area'
          ]
        },
        '7.SP': {
          title: 'Statistics and Probability',
          standards: [
            '7.SP.1: Statistics can gain information from a sample',
            '7.SP.2: Use data from random sample to draw inferences',
            '7.SP.3: Assess visual overlap of data distributions',
            '7.SP.4: Use measures of center and variability',
            '7.SP.5: Probability is a number between 0 and 1',
            '7.SP.6: Approximate probability by collecting data',
            '7.SP.7.a: Develop a uniform probability model',
            '7.SP.7.b: Develop probability model by observing frequencies',
            '7.SP.8: Find probabilities of compound events'
          ]
        }
      };
      setGrade7MathStandards(standards);
      setLoadingStandards(false);
    };

    loadGrade7Standards();
  }, []);

  const handleGoogleSignIn = () => {
    if (!window.google) {
      setError('Google Sign-In is loading. Please wait and try again.');
      return;
    }

    try {
      const client = window.google.accounts.oauth2.initTokenClient({
        client_id: '678343598174-cl1orhj1onnq5r79esv7sf0i6mht3p26.apps.googleusercontent.com',
        scope: [
          'https://www.googleapis.com/auth/classroom.courses.readonly',
          'https://www.googleapis.com/auth/classroom.coursework.students',
          'https://www.googleapis.com/auth/userinfo.profile',
          'https://www.googleapis.com/auth/userinfo.email'
        ].join(' '),
        callback: async (tokenResponse) => {
          if (tokenResponse.access_token) {
            setAccessToken(tokenResponse.access_token);
            await fetchUserInfo(tokenResponse.access_token);
            await fetchCourses(tokenResponse.access_token);
            setIsConnected(true);
            setActiveTab('courses');
          }
        },
      });
      client.requestAccessToken();
    } catch (err) {
      setError('Sign-in failed. Please try again or use Demo Mode.');
    }
  };

  const fetchUserInfo = async (token) => {
    try {
      const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const userData = await response.json();
      setUser(userData);
    } catch (error) {
      console.error('Error fetching user info:', error);
    }
  };

  const simulateConnection = () => {
    setUser({ name: 'Demo Teacher', email: 'demo@school.edu', picture: null });
    setAccessToken('demo_token');
    setIsConnected(true);
    setCourses([
      { id: '123456', name: 'Grade 7 Mathematics', section: 'Room 204' },
      { id: '789012', name: 'Grade 8 Algebra', section: 'Room 301' }
    ]);
    setActiveTab('courses');
  };

  const fetchCourses = async (token) => {
    try {
      const response = await fetch(
        'https://classroom.googleapis.com/v1/courses?courseStates=ACTIVE&pageSize=20',
        { headers: { 'Authorization': `Bearer ${token}` }}
      );
      if (response.ok) {
        const data = await response.json();
        setCourses(data.courses || []);
      } else {
        simulateConnection();
      }
    } catch (err) {
      simulateConnection();
    }
  };

  const fetchCourseDetails = async (courseId) => {
    setSelectedCourse(courseId);
    setError(null);
    
    try {
      if (accessToken && accessToken !== 'demo_token') {
        const courseworkResponse = await fetch(
          `https://classroom.googleapis.com/v1/courses/${courseId}/courseWork?pageSize=100`,
          { headers: { 'Authorization': `Bearer ${accessToken}` }}
        );

        const materialsResponse = await fetch(
          `https://classroom.googleapis.com/v1/courses/${courseId}/courseWorkMaterials?pageSize=100`,
          { headers: { 'Authorization': `Bearer ${accessToken}` }}
        );

        if (courseworkResponse.ok && materialsResponse.ok) {
          const courseworkData = await courseworkResponse.json();
          const materialsData = await materialsResponse.json();

          const assignments = (courseworkData.courseWork || []).map(work => ({
            id: work.id,
            title: work.title,
            description: work.description || 'No description provided',
            dueDate: work.dueDate ? `${work.dueDate.year}-${String(work.dueDate.month).padStart(2, '0')}-${String(work.dueDate.day).padStart(2, '0')}` : 'No due date',
            maxPoints: work.maxPoints || 0,
            type: work.workType || 'Assignment',
            materials: work.materials || [],
            state: work.state
          }));

          const materials = (materialsData.courseWorkMaterial || []).map(material => ({
            id: material.id,
            title: material.title,
            description: material.description || 'No description',
            materials: material.materials || []
          }));

          setCourseData({
            courseName: courses.find(c => c.id === courseId)?.name || "Course",
            assignments: assignments,
            materials: materials,
            syllabus: 'Course syllabus extracted from materials and assignments'
          });
        } else {
          throw new Error('Failed to fetch course data');
        }
      } else {
        useDemoData(courseId);
      }
    } catch (err) {
      console.error('Error fetching course details:', err);
      setError('Could not fetch course data. Using demo data.');
      useDemoData(courseId);
    }
    
    setActiveTab('setup');
  };

  const useDemoData = (courseId) => {
    setCourseData({
      courseName: courses.find(c => c.id === courseId)?.name || "Grade 7 Mathematics",
      assignments: [
        { 
          id: 1, 
          title: "Ratios and Proportions Worksheet", 
          description: "Complete problems on unit rates and proportional relationships",
          dueDate: "2024-12-25",
          maxPoints: 20,
          type: "Assignment",
          materials: []
        },
        { 
          id: 2, 
          title: "Expressions and Equations Quiz", 
          description: "Quiz on linear expressions and two-step equations",
          dueDate: "2024-12-28",
          maxPoints: 100,
          type: "Quiz",
          materials: []
        }
      ],
      materials: [],
      syllabus: "Grade 7 Mathematics covering ratios, number system, expressions, geometry, and statistics"
    });
  };

  const analyzeWithClaude = async () => {
    if (!gradeLevel || !subject) {
      setError('Please select both grade level and subject.');
      return;
    }

    setIsAnalyzing(true);
    setError(null);

    setTimeout(() => {
      setAnalysis({
        overallAlignment: {
          score: 72,
          summary: "Course shows moderate alignment with California standards. Strong in ratios and expressions but needs more statistics and geometry content.",
          domainCoverage: {
            '7.RP': 80,
            '7.NS': 65,
            '7.EE': 75,
            '7.G': 45,
            '7.SP': 30
          }
        },
        standardsAnalysis: {
          fullyAligned: [
            {
              standard: "7.RP.1: Compute unit rates",
              evidence: "Ratios and Proportions Worksheet addresses this directly",
              quality: "Good coverage with multiple practice problems"
            }
          ],
          partiallyAligned: [
            {
              standard: "7.EE.1: Linear expressions",
              currentCoverage: "Quiz covers basic expressions",
              missing: "Need more complex factoring and expansion problems"
            }
          ],
          notAddressed: [
            {
              standard: "7.SP.1-8: Statistics and Probability",
              importance: "Critical for data literacy and real-world applications",
              impact: "Students will struggle with data analysis in Grade 8"
            }
          ]
        },
        assignmentAnalysis: [
          {
            assignment: "Ratios and Proportions Worksheet",
            strengths: ["Addresses 7.RP standards", "Clear progression"],
            weaknesses: ["Missing real-world applications", "No visual representations"],
            alignmentScore: 75,
            standardsAddressed: ["7.RP.1", "7.RP.2.a"],
            recommendedChanges: ["Add word problems with real contexts", "Include graphs and tables"]
          }
        ],
        recommendations: {
          immediate: [
            {
              action: "Add statistics unit",
              standard: "7.SP.1-4",
              implementation: "Create activities on sampling and data analysis",
              timeframe: "Next 2 weeks",
              resources: "Data sets, graphing tools"
            }
          ],
          shortTerm: ["Add geometry activities", "Include more probability problems"],
          longTerm: ["Develop integrated projects", "Build formative assessments"]
        },
        gapAnalysis: {
          criticalGaps: ["Statistics domain severely under-represented", "Geometry standards missing"],
          sequencingIssues: ["Should introduce geometry before complex algebra"],
          depthConcerns: ["Surface-level treatment of number system"]
        },
        alternativeActivities: [
          {
            replaces: "Ratios Worksheet",
            activity: "Recipe Scaling Project",
            standards: ["7.RP.1", "7.RP.2.c", "7.RP.3"],
            rationale: "Provides real-world context and deeper understanding",
            implementation: "Students scale recipes for different serving sizes, create tables and graphs",
            assessmentStrategy: "Rubric for accuracy, explanation, and visual representation",
            differentiationOptions: "Simpler recipes for struggling learners, multi-step conversions for advanced"
          }
        ]
      });
      setIsAnalyzing(false);
      setActiveTab('results');
    }, 2000);
  };

  const handleSignOut = () => {
    setIsConnected(false);
    setUser(null);
    setAccessToken(null);
    setCourses([]);
    setActiveTab('connect');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Brain className="w-8 h-8 text-indigo-600" />
              <div>
                <h1 className="text-3xl font-bold text-gray-800">California Common Core Analyzer</h1>
                <p className="text-sm text-gray-600">AI-Powered Standards Alignment</p>
              </div>
            </div>
            <div className="flex items-center gap-4">
              {isConnected && user && (
                <div className="flex items-center gap-3">
                  {user.picture && <img src={user.picture} alt={user.name} className="w-8 h-8 rounded-full" />}
                  <div>
                    <div className="text-sm font-medium">{user.name}</div>
                    <div className="text-xs text-gray-500">{user.email}</div>
                  </div>
                  <button onClick={handleSignOut} className="p-2 hover:bg-gray-100 rounded-lg">
                    <LogOut className="w-5 h-5 text-gray-600" />
                  </button>
                </div>
              )}
              <div className="flex items-center gap-2">
                {isConnected ? (
                  <>
                    <CheckCircle className="w-5 h-5 text-green-500" />
                    <span className="text-sm text-green-600 font-medium">Connected</span>
                  </>
                ) : (
                  <>
                    <AlertCircle className="w-5 h-5 text-gray-400" />
                    <span className="text-sm text-gray-500">Not connected</span>
                  </>
                )}
              </div>
            </div>
          </div>
        </div>

        {error && (
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <p className="text-yellow-800 text-sm">{error}</p>
          </div>
        )}

        <div className="bg-white rounded-lg shadow-lg mb-6">
          <div className="flex border-b overflow-x-auto">
            {['connect', 'courses', 'setup', 'results'].map((tab) => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                disabled={!isConnected && tab !== 'connect'}
                className={`flex-1 py-4 px-6 text-center font-medium capitalize ${activeTab === tab ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500'} ${!isConnected && tab !== 'connect' ? 'opacity-50 cursor-not-allowed' : ''}`}
              >
                {tab === 'setup' ? 'Configure' : tab}
              </button>
            ))}
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-lg p-6">
          {activeTab === 'connect' && (
            <div className="text-center py-12">
              <BookOpen className="w-16 h-16 text-indigo-600 mx-auto mb-4" />
              <h2 className="text-2xl font-bold mb-4">Connect Your Google Classroom</h2>
              <p className="text-gray-600 mb-8 max-w-md mx-auto">
                Sign in to analyze your courses against California Common Core Standards
              </p>
              <button onClick={handleGoogleSignIn} className="bg-white border-2 border-gray-300 px-8 py-3 rounded-lg font-medium hover:bg-gray-50 flex items-center gap-3 mx-auto mb-4">
                <svg className="w-5 h-5" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
              </button>
              <button onClick={simulateConnection} className="text-sm text-gray-500 underline">
                Try Demo Mode
              </button>
            </div>
          )}

          {activeTab === 'courses' && (
            <div>
              <h2 className="text-2xl font-bold mb-6">Select a Course</h2>
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                {courses.map(course => (
                  <button
                    key={course.id}
                    onClick={() => fetchCourseDetails(course.id)}
                    className="text-left p-6 border-2 rounded-lg hover:border-indigo-400 hover:bg-indigo-50"
                  >
                    <h3 className="font-semibold text-lg mb-2">{course.name}</h3>
                    <p className="text-sm text-gray-600">{course.section}</p>
                  </button>
                ))}
              </div>
            </div>
          )}

          {activeTab === 'setup' && courseData && (
            <div>
              <h2 className="text-2xl font-bold mb-6">Configure Analysis</h2>
              <div className="bg-gray-50 rounded-lg p-6 mb-6">
                <h3 className="font-semibold text-lg mb-4">{courseData.courseName}</h3>
                <div className="grid md:grid-cols-2 gap-6 mb-6">
                  <div>
                    <label className="block text-sm font-medium mb-2">Grade Level</label>
                    <select value={gradeLevel} onChange={(e) => setGradeLevel(e.target.value)} className="w-full border rounded-lg px-4 py-2">
                      <option value="">Select Grade</option>
                      <option value="7">Grade 7</option>
                      <option value="8">Grade 8</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Subject</label>
                    <select value={subject} onChange={(e) => setSubject(e.target.value)} className="w-full border rounded-lg px-4 py-2">
                      <option value="">Select Subject</option>
                      <option value="Math">Mathematics</option>
                    </select>
                  </div>
                </div>

                <div>
                  <h4 className="font-medium mb-2">Assignments ({courseData.assignments.length}):</h4>
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {courseData.assignments.map(a => (
                      <div key={a.id} className="bg-white p-3 rounded border text-sm">
                        <div className="font-medium">{a.title}</div>
                        <div className="text-xs text-gray-600">{a.description}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <button
                onClick={analyzeWithClaude}
                disabled={isAnalyzing || !gradeLevel || !subject}
                className="w-full bg-indigo-600 text-white px-6 py-4 rounded-lg font-medium hover:bg-indigo-700 disabled:bg-gray-400 flex items-center justify-center gap-2"
              >
                {isAnalyzing ? 'Analyzing...' : 'Analyze Standards Alignment'}
              </button>
            </div>
          )}

          {activeTab === 'results' && analysis && (
            <div className="space-y-6">
              <h2 className="text-2xl font-bold">Analysis Results</h2>
              <div className="bg-indigo-50 rounded-lg p-6">
                <div className="flex justify-between items-center">
                  <div>
                    <h3 className="text-lg font-semibold mb-2">Overall Score</h3>
                    <p className="text-gray-700">{analysis.overallAlignment.summary}</p>
                  </div>
                  <div className="text-5xl font-bold text-indigo-600">{analysis.overallAlignment.score}%</div>
                </div>
              </div>

              <div>
                <h3 className="text-xl font-semibold mb-4">Standards Coverage</h3>
                <div className="grid md:grid-cols-3 gap-4">
                  <div className="bg-green-50 p-4 rounded-lg">
                    <h4 className="font-medium text-green-900 mb-2">Fully Aligned</h4>
                    {analysis.standardsAnalysis.fullyAligned.map((item, i) => (
                      <div key={i} className="text-sm mb-2">
                        <div className="font-medium">{item.standard}</div>
                        <div className="text-green-700">{item.evidence}</div>
                      </div>
                    ))}
                  </div>
                  <div className="bg-yellow-50 p-4 rounded-lg">
                    <h4 className="font-medium text-yellow-900 mb-2">Partially Aligned</h4>
                    {analysis.standardsAnalysis.partiallyAligned.map((item, i) => (
                      <div key={i} className="text-sm mb-2">
                        <div className="font-medium">{item.standard}</div>
                        <div className="text-yellow-700">{item.currentCoverage}</div>
                      </div>
                    ))}
                  </div>
                  <div className="bg-red-50 p-4 rounded-lg">
                    <h4 className="font-medium text-red-900 mb-2">Not Addressed</h4>
                    {analysis.standardsAnalysis.notAddressed.map((item, i) => (
                      <div key={i} className="text-sm mb-2">
                        <div className="font-medium">{item.standard}</div>
                        <div className="text-red-700">{item.importance}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div>
                <h3 className="text-xl font-semibold mb-4">Recommendations</h3>
                {analysis.recommendations.immediate.map((rec, i) => (
                  <div key={i} className="border-l-4 border-red-500 bg-red-50 p-4 mb-3">
                    <div className="font-medium">{rec.action}</div>
                    <div className="text-sm text-red-800 mt-1">Standard: {rec.standard}</div>
                    <div className="text-sm mt-1">{rec.implementation}</div>
                  </div>
                ))}
              </div>

              <button onClick={() => setActiveTab('setup')} className="bg-gray-200 px-6 py-3 rounded-lg">
                Analyze Another Course
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default AIClassroomAgent;
